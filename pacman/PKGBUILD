# Maintainer: rhubarb-geek-nz@users.sourceforge.net
pkgname=powershell
pkgver=7.3.11
pkgrel=1
epoch=
pkgdesc="PowerShell is an automation and configuration management platform."
arch=("$CARCH")
url="https://github.com/PowerShell/PowerShell"
license=('MIT')
groups=()
depends=('glibc' 'gcc-libs' 'krb5' 'pam' 'zlib' 'lttng-ust2.12')
makedepends=()
checkdepends=()
optdepends=()
provides=()
conflicts=()
replaces=()
backup=()
options=()
install=
changelog=
noextract=()
md5sums=()
validpgpkeys=()

prepare() {
	mkdir "$pkgname-$pkgver"

	(
		cd "$pkgname-$pkgver"

		case "$arch" in
			arm* )
				URL="https://github.com/PowerShell/PowerShell/releases/download/v$pkgver/powershell-$pkgver-linux-arm32.tar.gz"
				CHK=B4DEDFC17BE63738305AC2BB4333EFE7D31BFF1A4BEDED64A8E588D5BEA4D166
				;;
			aarch64 )
				URL="https://github.com/PowerShell/PowerShell/releases/download/v$pkgver/powershell-$pkgver-linux-arm64.tar.gz"
				CHK=3EA428844BB741B96E0CD55A6353B73FCE006F54242B6BC2C3CEBB64BC2365D8
				;;
			x86_64 )
				URL="https://github.com/PowerShell/PowerShell/releases/download/v$pkgver/powershell-$pkgver-linux-x64.tar.gz"
				CHK=674CABD4AC9EAD59C1BBBDCE3FBE07134215128AF1C429A41FE74DDE96928BD4
				;;
			* )
				false
				;;
		esac

		echo Loading "$URL"

		curl "$URL" --location --fail --silent --output pwsh.tar.gz

		ACT=$(sha256sum pwsh.tar.gz | tr "[:lower:]" "[:upper:]" | while read A B; do echo $A; break; done)
	
		if test "$ACT" != "$CHK"
		then
			echo "$ACT" != "$CHK"
			exit 1
		fi

		URL="https://github.com/PowerShell/PowerShell/releases/download/v$pkgver/powershell_$pkgver-1.deb_amd64.deb"
		CHK=05E9727D4ACBD24522EBFAC6B7BE72FF2E199D2D94105276D7ED712CA811CFF7

		echo Loading "$URL"

		curl "$URL" --location --fail --silent --output pwsh.deb

		ACT=$(sha256sum pwsh.deb | tr "[:lower:]" "[:upper:]" | while read A B; do echo $A; break; done)

		if test "$ACT" != "$CHK"
		then
			echo "$ACT" != "$CHK"
			exit 1
		fi
	)
}

build() {
	cd "$pkgname-$pkgver"

	ar t pwsh.deb | while read N
	do
		case "$N" in
			data.tar.xz )
				ar p pwsh.deb "$N" | ( mkdir data ; cd data ; tar xfJ - )
				;;
			data.tar.gz )
				ar p pwsh.deb "$N" | ( mkdir data ; cd data ; tar xfz - )
				;;
			* )
				;;
		esac
	done

	(
		mkdir pwsh
		cd pwsh
		tar xfz ../pwsh.tar.gz
	)
}

check() {
	pwd
	test -d "$pkgname-$pkgver/data"
	test -d "$pkgname-$pkgver/pwsh"
}

package() {
	find "$pkgname-$pkgver/pwsh" -type f | xargs chmod -x 
	chmod +x "$pkgname-$pkgver/pwsh/pwsh"
	"$pkgname-$pkgver/pwsh/pwsh" -Version
	mkdir -p "$pkgdir"
	mv "$pkgname-$pkgver/data"/* "$pkgdir/"
	find "$pkgdir/" -name man
	if test -d "$pkgdir/usr/local/share/man"
	then
		if test ! -d "$pkgdir/usr/share/man"
		then
			mv "$pkgdir/usr/local/share/man" "$pkgdir/usr/share/man"
		fi
	fi
	rm -rf "$pkgdir/usr/local"
	find "$pkgdir" -type d
	rm -rf "$pkgdir/opt/microsoft/powershell/7"
	mv "$pkgname-$pkgver/pwsh" "$pkgdir/opt/microsoft/powershell/7"
}
