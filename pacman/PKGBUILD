# Maintainer: rhubarb-geek-nz@users.sourceforge.net
pkgname=powershell
pkgver=7.2.19
pkgrel=1
epoch=
pkgdesc="PowerShell is an automation and configuration management platform."
arch=("$CARCH")
url="https://github.com/PowerShell/PowerShell"
license=('MIT')
groups=()
depends=('glibc' 'gcc-libs' 'krb5' 'pam' 'zlib' 'lttng-ust2.12')
makedepends=()
checkdepends=()
optdepends=()
provides=()
conflicts=()
replaces=()
backup=()
options=()
install=
changelog=
noextract=()
md5sums=()
validpgpkeys=()

prepare() {
	mkdir "$pkgname-$pkgver"

	(
		cd "$pkgname-$pkgver"

		case "$arch" in
			arm* )
				URL="https://github.com/PowerShell/PowerShell/releases/download/v$pkgver/powershell-$pkgver-linux-arm32.tar.gz"
				CHK=3E05DDA2C227FD26DE0661620C666A53D759B54C39CBC413E9D6E49949089F2A
				;;
			aarch64 )
				URL="https://github.com/PowerShell/PowerShell/releases/download/v$pkgver/powershell-$pkgver-linux-arm64.tar.gz"
				CHK=60F6990969BAA6E628F2E7A88CD8C997B6778B86AA096E311C6F2DE0134610AC
				;;
			x86_64 )
				URL="https://github.com/PowerShell/PowerShell/releases/download/v$pkgver/powershell-$pkgver-linux-x64.tar.gz"
				CHK=5817185496A66BAA321CD3DB8CB791BC341E72FFF2B471BAD58A6017DB50624A
				;;
			* )
				false
				;;
		esac

		echo Loading "$URL"

		curl "$URL" --location --fail --silent --output pwsh.tar.gz

		ACT=$(sha256sum pwsh.tar.gz | tr "[:lower:]" "[:upper:]" | while read A B; do echo $A; break; done)
	
		if test "$ACT" != "$CHK"
		then
			echo "$ACT" != "$CHK"
			exit 1
		fi

		URL="https://github.com/PowerShell/PowerShell/releases/download/v$pkgver/powershell_$pkgver-1.deb_amd64.deb"
		CHK=A553F3890B2FC04DFB5D3E3C812106C4753201A63A4E1C8FFBF94135E145D31C

		echo Loading "$URL"

		curl "$URL" --location --fail --silent --output pwsh.deb

		ACT=$(sha256sum pwsh.deb | tr "[:lower:]" "[:upper:]" | while read A B; do echo $A; break; done)

		if test "$ACT" != "$CHK"
		then
			echo "$ACT" != "$CHK"
			exit 1
		fi
	)
}

build() {
	cd "$pkgname-$pkgver"

	ar t pwsh.deb | while read N
	do
		case "$N" in
			data.tar.xz )
				ar p pwsh.deb "$N" | ( mkdir data ; cd data ; tar xfJ - )
				;;
			data.tar.gz )
				ar p pwsh.deb "$N" | ( mkdir data ; cd data ; tar xfz - )
				;;
			* )
				;;
		esac
	done

	(
		mkdir pwsh
		cd pwsh
		tar xfz ../pwsh.tar.gz
	)
}

check() {
	pwd
	test -d "$pkgname-$pkgver/data"
	test -d "$pkgname-$pkgver/pwsh"
}

package() {
	find "$pkgname-$pkgver/pwsh" -type f | xargs chmod -x 
	chmod +x "$pkgname-$pkgver/pwsh/pwsh"
	"$pkgname-$pkgver/pwsh/pwsh" -Version
	mkdir -p "$pkgdir"
	mv "$pkgname-$pkgver/data"/* "$pkgdir/"
	find "$pkgdir/" -name man
	if test -d "$pkgdir/usr/local/share/man"
	then
		if test ! -d "$pkgdir/usr/share/man"
		then
			mv "$pkgdir/usr/local/share/man" "$pkgdir/usr/share/man"
		fi
	fi
	rm -rf "$pkgdir/usr/local"
	find "$pkgdir" -type d
	rm -rf "$pkgdir/opt/microsoft/powershell/7"
	mv "$pkgname-$pkgver/pwsh" "$pkgdir/opt/microsoft/powershell/7"
}
